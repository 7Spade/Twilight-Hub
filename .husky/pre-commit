#!/bin/sh

# è¨­ç½®éŒ¯èª¤è™•ç†
set -e

# è¨˜éŒ„é–‹å§‹æ™‚é–“
start_time=$(date +%s)

echo "ğŸš€ é–‹å§‹ pre-commit æª¢æŸ¥..."

# 1. æª¢æŸ¥å¿…è¦è…³æœ¬æ˜¯å¦å­˜åœ¨
if [ ! -f "scripts/generate-tree.ts" ]; then
  echo "âŒ éŒ¯èª¤: scripts/generate-tree.ts ä¸å­˜åœ¨"
  exit 1
fi

if [ ! -f "scripts/todo-automation-toolkit.ts" ]; then
  echo "âŒ éŒ¯èª¤: scripts/todo-automation-toolkit.ts ä¸å­˜åœ¨"
  exit 1
fi

# 2. å…ˆåŸ·è¡Œ lint-stagedï¼ˆå¿«é€Ÿæª¢æŸ¥å·²æš«å­˜æª”æ¡ˆï¼‰
echo "ğŸ” åŸ·è¡Œ lint-staged æª¢æŸ¥..."
if ! npx lint-staged; then
  echo "âŒ lint-staged æª¢æŸ¥å¤±æ•—ï¼Œè«‹ä¿®å¾©éŒ¯èª¤å¾Œé‡è©¦"
  exit 1
fi

# 3. åŸ·è¡Œ TypeScript é¡å‹æª¢æŸ¥ï¼ˆæš«æ™‚è·³éï¼Œå¾…ä¿®å¾©èªæ³•éŒ¯èª¤å¾Œå•Ÿç”¨ï¼‰
# echo "ğŸ” åŸ·è¡Œ TypeScript é¡å‹æª¢æŸ¥..."
# if ! npm run typecheck; then
#   echo "âŒ TypeScript é¡å‹æª¢æŸ¥å¤±æ•—ï¼Œè«‹ä¿®å¾©éŒ¯èª¤å¾Œé‡è©¦"
#   exit 1
# fi

# 4. æ›´æ–°é …ç›®çµæ§‹æ–‡æª”
echo "ğŸ”„ æ›´æ–°é …ç›®çµæ§‹æ–‡æª”..."
if ! npm run docs:update; then
  echo "âŒ æ›´æ–°é …ç›®çµæ§‹æ–‡æª”å¤±æ•—"
  exit 1
fi

# 5. æƒæ TODO åˆ—è¡¨
echo "ğŸ”„ æƒæ TODO åˆ—è¡¨..."
if ! npm run todo:scan; then
  echo "âŒ TODO æƒæå¤±æ•—"
  exit 1
fi

# 6. å°‡è®Šæ›´æª”æ¡ˆåŠ å…¥åˆ°æš«å­˜ï¼ˆè‹¥ç„¡è®Šæ›´å‰‡ä¸å½±éŸ¿ï¼‰
echo "ğŸ“ å°‡æ›´æ–°çš„æ–‡æª”åŠ å…¥æš«å­˜..."
git add docs/project-structure.md 2>/dev/null || true
git add .todo-reports/ 2>/dev/null || true

# 7. è¨ˆç®—åŸ·è¡Œæ™‚é–“
end_time=$(date +%s)
duration=$((end_time - start_time))

echo "âœ… æ‰€æœ‰æª¢æŸ¥å®Œæˆï¼Œæ–‡æª”å·²æ›´æ–°ä¸¦åŠ å…¥æäº¤"
echo "â±ï¸  ç¸½åŸ·è¡Œæ™‚é–“: ${duration} ç§’"